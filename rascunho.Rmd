---
title: "Machine Learning para prever salário de cientistas de dados"
subtitle: "Utilizando base de dados fornecida por DataHackers"
author: "Fellipe Gomes"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, error = F, message = F)

library(tidyverse)
library(DataExplorer)
# library(patchwork)

theme_set(theme_bw())
```

# Definica do Problema

A partir dos dados disponibilizados ...
é possivel aplicar diferentes abordagens nesses dados...

## Descricao do problema

<!-- * Descricao informal -->

Problema para prever o salário de um cientista de dados 

<!-- * Descricao formal --> 

Y = salário de um cientista de dados

<!-- * Premissas -->

* Dados anonimizados 

## Dados Fornecidos

```{r}
# read dataset
dataset <- read_csv("datahackers-survey-2019-anonymous-responses.csv")

# fix colnames
dataset <- 
  dataset %>% 
  janitor::clean_names()

# quantidade de opcoes por pergunta (ordenado do maior para o menor)
(
  MORE_QUESTIONS <- 
    dataset %>% 
    colnames() %>%
    str_extract("(p|d)[0-9]{1,}") %>% 
    table() %>% 
    .[.>1] %>% 
    sort(decreasing = T)
)

# Perguntas com mais de 1 resposta:
names(MORE_QUESTIONS)
MORE_QUESTIONS <- MORE_QUESTIONS[names(MORE_QUESTIONS) != "p35"] 

# Quantidade de respostas ordenada
dataset %>% 
  select(str_which(colnames(dataset), paste0(names(MORE_QUESTIONS), collapse = "|"))) %>%
  map_df(sum) %>% 
  gather() %>% 
  arrange(-value) %>% 
  separate(key, c("pergunta", "resposta"),  "_", extra = "merge")
```

<!-- * Restrições impostas aos dados --> 

* pesquisa foi conduzida de forma online durante o mês de Novembro de 2019
* dataset foi anonimizado
* remover alguns outliers que poderiam identificar o entrevistado e, portanto, nem todos os dados coletados na pesquisa estarão disponíveis aqui
* Estados com menor incidência de resposta, como aqueles das regiões Norte, Nordeste e Centro-Oeste terão apenas sua região indicada no dataset (tambem como consequencia da anonimização)
* As perguntas cujas respostas são multi-valoradas ocupam mais de uma coluna no dataset
* Categorias foram convertidas para dummie

<!-- * Definicao de cada atributo -->

Pode ser conferida em: <https://www.kaggle.com/datahackers/pesquisa-data-hackers-2019>

Perguntas realizadas e pré-seleção de atributos para previsão de salário:



|  Indice | Pergunda | Seleção |
|:--|:--|:--:|
| P1 | Idade? [Mascarada] | <span style="color: red;">✗</span> |
| P2 | Gênero? [Mascarada] | <span style="color: red;">✗</span>  |
| P3 | Atualmente você vive no Brasil? | <span style="color: red;">✗</span>  |
| P4 | Em que país você vive hoje? | <span style="color: red;">✗</span>  |
| P5 | Em que estado você vive hoje? [Mascarada] | <span style="color: red;">✗</span>  |
| P6 | Na questão anterior você disse que vive em. Esse é seu estado de origem (onde nasceu ou se formou)? | <span style="color: red;">✗</span>  |
| P7 | Qual seu estado de origem? | <span style="color: red;">✗</span>  |
| P8 | Qual seu nível de ensino? | <span style="color: green;">✔</span>  |
| P9 | Qual sua área de formação? | <span style="color: green;">✔</span>  |
| P10 | Qual sua situação atual de trabalho? | <span style="color: red;">✗</span>  |
| P11 | A empresa em que você trabalha pertence a qual setor? | <span style="color: green;">✔</span>  |
| P12 | A empresa em que você trabalha possui quantos funcionários atualmente? | <span style="color: green;">✔</span>  |
| P13 | Você atua como gestor? | <span style="color: green;">✔</span>  |
| P14 | Qual das opções abaixo definem melhor seu cargo de trabalho atual como gestor? | <span style="color: green;">✔</span>  |
| P15 | Qual das opções abaixo definem melhor seu cargo de trabalho atual? | <span style="color: green;">✔</span>  |
| P16 | Qual sua faixa salarial atual? [Mascarada] | <span style="color: green;">✔</span>  |
| P17 | Quanto tempo de experiência na área de dados você tem? | <span style="color: green;">✔</span>  |
| P18 | Quanto tempo de experiência na área de TI/Engenharia de Software você teve antes de começar a trabalhar na área de dados? | <span style="color: green;">✔</span>  |
| P19 | Você se considera um profissional que atua na área de Data Science? | <span style="color: green;">✔</span>  |
| P20 | Quais dos métodos listados abaixo você costuma utilizar no trabalho? | <span style="color: green;">✔</span>  |
| P21 | Quais das linguagens de programação listadas abaixo você utiliza no trabalho? | <span style="color: green;">✔</span>  |
| P22 | Entre as linguagens de programação listadas abaixo, qual é a que você mais utiliza no trabalho? [Mascarada] | <span style="color: green;">✔</span>  |
| P23 | Quais das fontes de dados listadas você já analisou no trabalho? | <span style="color: green;">✔</span>  |
| P24 | Entre as fontes de dados listadas, quais você utiliza na maior parte do tempo? Selecione no máximo duas opções que você mais utiliza. | <span style="color:  green;">✔</span> |
| P25 | Quais das opções de Cloud listadas abaixo você utiliza no trabalho? | <span style="color: green;">✔</span>  |
| P26 | Quais dos bancos de dados/fontes de dados listados abaixo você utiliza para consultar informações, e posteriormente analisar, no trabalho? | <span style="color:  green;">✔</span> |
| P27 | Quais as Ferramentas de Business Intelligence você utiliza no trabalho? | <span style="color: green;">✔</span>  |
| P28 | Quais as tecnologias são utilizadas como ferramenta de ETL no seu trabalho? | <span style="color: green;">✔</span>  |
| P29 | Sua organização possui um Data Warehouse? | <span style="color: green;">✔</span>  |
| P30 | Qual tecnologia utilizada como plataforma do Data Warehouse? | <span style="color: green;">✔</span>  |
| P31 | Quais das iniciativas do Data Hackers que você já acessou/acompanhou? | <span style="color: red;">✗</span>  |
| P32 | Entre as iniciativas do Data Hackers qual a sua preferida? | <span style="color: red;">✗</span>  |
| P33 | De quais outras formas que você costuma se atualizar no mundo dos dados? | <span style="color: green;">✔</span>  |
| P34 | Em quais dessas plataformas listadas abaixo você já iniciou/completou cursos na área de Data Science? | <span style="color: green;">✔</span>  |
| P35 | Dentre as plataformas listadas abaixo qual foi a sua preferida para cursos de Data Science? | <span style="color: red;">✗</span>  |

Além dessas, derivamos algumas outras colunas:

|  Indice | Pergunda | Seleção |
|:--|:--|:--:|
|D1 | Macrorregião em que mora | <span style="color: red;">✗</span> |
|D2 | Macrorregião em que nasceu | <span style="color: red;">✗</span> |
|D3 | Área de formação anonimizada | <span style="color: green;">✔</span> |
|D4 | Setor de mercado anonimizado | <span style="color: green;">✔</span> |
|D5 | Nível de gerência anonimizado | <span style="color: green;">✔</span> |
|D6 | Cargo anonimizado | <span style="color: green;">✔</span> |


Filtros:

  * Moradores do Brasil
  * Pessoas que estejam no mercado
  

<!-- Definicao da resposta -->

```{r}
# Conferir quem sao os individuos que nao declararam o salario:
dataset %>% 
  count(p10_job_situation, p16_salary_range) %>% 
  filter(is.na(p16_salary_range))

# remover estes individuos do dataset:
dataset <- 
  dataset %>% 
  filter(p3_living_in_brasil == 1) %>% 
  filter(!is.na(p16_salary_range))
```

```{r}
# Converter para fator ordenado
dataset <- 
  dataset %>% 
  mutate(p16_salary_range = factor(p16_salary_range, 
                                   levels = c("Menos de R$ 1.000/mês",
                                              "de R$ 1.001/mês a R$ 2.000/mês",
                                              "de R$ 2.001/mês a R$ 3000/mês",
                                              "de R$ 3.001/mês a R$ 4.000/mês",
                                              "de R$ 4.001/mês a R$ 6.000/mês",
                                              "de R$ 6.001/mês a R$ 8.000/mês",
                                              "de R$ 8.001/mês a R$ 12.000/mês",
                                              "de R$ 12.001/mês a R$ 16.000/mês",
                                              "de R$ 16.001/mês a R$ 20.000/mês",
                                              "de R$ 20.001/mês a R$ 25.000/mês",
                                              "Acima de R$ 25.001/mês")))

# before fix y
p1 <- 
  plotly::ggplotly(
    dataset %>% 
      count(p16_salary_range) %>% 
      ggplot(aes(x= p16_salary_range, y = n))+
      geom_bar(stat = "identity") +
      theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
  )


# Agregar salarios com menor frequencia
dataset <- 
  dataset %>% 
  mutate(p16_salary_range = as.character(p16_salary_range),
         p16_salary_range = 
           case_when(
             p16_salary_range == "Menos de R$ 1.000/mês" ~ "Menos de R$ 2.000/mês",
             p16_salary_range == "de R$ 1.001/mês a R$ 2.000/mês" ~ "Menos de R$ 2.000/mês",
             p16_salary_range == "de R$ 2.001/mês a R$ 3000/mês" ~ "de R$ 2.001/mês a R$ 3.000/mês",
             p16_salary_range == "de R$ 12.001/mês a R$ 16.000/mês" ~ "Acima de R$ 12.001/mês",
             p16_salary_range == "de R$ 16.001/mês a R$ 20.000/mês" ~ "Acima de R$ 12.001/mês",
             p16_salary_range == "de R$ 20.001/mês a R$ 25.000/mês" ~ "Acima de R$ 12.001/mês",
             p16_salary_range == "Acima de R$ 25.001/mês" ~ "Acima de R$ 12.001/mês",
             TRUE ~ as.character(p16_salary_range)),
         p16_salary_range = 
           factor(p16_salary_range, 
                  levels = c("Menos de R$ 2.000/mês",
                             "de R$ 2.001/mês a R$ 3.000/mês",
                             "de R$ 3.001/mês a R$ 4.000/mês",
                             "de R$ 4.001/mês a R$ 6.000/mês",
                             "de R$ 6.001/mês a R$ 8.000/mês",
                             "de R$ 8.001/mês a R$ 12.000/mês",
                             "Acima de R$ 12.001/mês")))

# after fix y
p2 <- 
  plotly::ggplotly(
    dataset %>% 
      count(p16_salary_range) %>% 
      ggplot(aes(x= p16_salary_range, y = n))+
      geom_bar(stat = "identity") +
      theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
  )

plotly::subplot(p1, p2)
```




 
## Motivacao

* Motivacao 
* Beneficios
* Uso

# Resumir/Analisar Dados

```{r}
# create_report(dataset, y = "p16_salary_range")

introduce(dataset) %>% gather()
plot_intro(dataset)
plot_missing(dataset, missing_only = T)
```

## Estatisticas descritivas:

<!-- * Estrutura dos dados  -->

```{r}
visdat::vis_dat(dataset)

dataset %>% 
  map_dbl(~sum(is.na(.x))) %>% 
  .[.!=0] %>% 
  {tibble(pergunta = names(.), n = .)} %>% 
  arrange(-n)
```


* Distribuicoes dos dados
* summary, VarType, Corr Matrix, Count os class labels

## Visualizacoes 

histogramas, densidades, boxplots, dispersao, matrix de correlacoes

# Preparar dados

## Selecao de Atributos

## Limpeza dos dados

Formato, Limpeza, Amostragem

## Testar suposiçoes

Normalidade, igualdades, etc

## Transformacao dos dados

Scale, decomposicao, agregacao

# Avaliar agoritmos

## Separar dados de treino/validacao/teste

## Testar opcoes e metricas de avaliacao

Por nivel de dificuldade (do mais facil para o mais dificil):

1. knn, naive-bayes, 
2. logit, decision tree, lasso, elasticnet, svm, 
3. randomforest, gbm, xgboost, nnet
4. h2o::automl

## Algoritmos de verificação 

baseline

## Comparar algoritmos

metricas, proporcao de dados (palavras) utilizadas, tempo de processamento, tempo de estimacao etc


# Melhorar a acuracia

## Tunning algoritmos

grid search

## Conjuntos (Ensembles)

modelo hibrido?

bagging, boosting, blending

"extreme feature engineering"

# Finalizar modelo

Contexto
Problema
Solucao
Achados
Limitacoes
Conclusoes

## Previsoes no dataset de teste

## Salvar modelo para deploy / Operacionalizar algoritmo

Shiny?

